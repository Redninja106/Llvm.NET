<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Kaleidoscope Tutorial | Llvm.NET </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Kaleidoscope Tutorial | Llvm.NET ">
    <meta name="generator" content="docfx 2.29.1.0">
    
    <link rel="shortcut icon" href="../../favicon.ico">
    <link rel="stylesheet" href="../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/docfx.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <meta property="docfx:navrel" content="../../toc">
    <meta property="docfx:tocrel" content="toc">
    
    
    
  </head>
  <body data-spy="scroll" data-target="#affix">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../index.html">
                <img id="logo" class="svg" src="../../DragonSharp48x48.png" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
                <ul class="nav level1 navbar-nav">
                  <li class="">
                    <a href="../../api/index.html" title="API Documentation" class="">API Documentation</a>
                  </li>
                  <li class="">
                    <a href="../../articles/index.html" title="Articles" class="">Articles</a>
                  </li>
                  <li class="">
                    <a href="http://LLVM.org" title="LLVM.org" class="">LLVM.org</a>
                  </li>
                  <li class="">
                    <a href="http://releases.llvm.org/5.0.0/docs/index.html" title="LLVM Docs" class="">LLVM Docs</a>
                  </li>
                </ul>
            </div>
          </div>
        </nav>
      </header>
      <div role="main" class="container body-content hide-when-search">
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div>
              <div class="sidefilter">
                <form class="toc-filter">
                  <span class="glyphicon glyphicon-filter filter-icon"></span>
                  <input type="text" id="toc_filter_input" placeholder="Enter here to filter..." onkeypress="if(event.keyCode==13) {return false;}">
                </form>
              </div>
              <div class="sidetoc">
                <div class="toc" id="toc">
                  
                  <ul class="nav level1">
                    <li class="">
                      <a href="codegeneration.html" title="Code Generation" class="">Code Generation</a>
                    </li>
                    <li class="active">
                      <span class="expand-stub"></span>
                      <a href="Kaleidoscope.html" title="Kaleidoscope" class="active">Kaleidoscope</a>
                        
                        <ul class="nav level2">
                          <li class="">
                            <a href="Kaleidoscope-ch2.html" title="Chapter 2" class="">Chapter 2</a>
                          </li>
                          <li class="">
                            <a href="Kaleidoscope-ch3.html" title="Chapter 3" class="">Chapter 3</a>
                          </li>
                          <li class="">
                            <a href="Kaleidoscope-ch4.html" title="Chapter 4" class="">Chapter 4</a>
                          </li>
                          <li class="">
                            <a href="Kaleidoscope-ch5.html" title="Chapter 5" class="">Chapter 5</a>
                          </li>
                          <li class="">
                            <a href="Kaleidoscope-ch6.html" title="Chapter 6" class="">Chapter 6</a>
                          </li>
                          <li class="">
                            <a href="Kaleidoscope-ch7.html" title="Chapter 7" class="">Chapter 7</a>
                          </li>
                          <li class="">
                            <a href="Kaleidoscope-ch8.html" title="Chapter 8" class="">Chapter 8</a>
                          </li>
                          <li class="">
                            <a href="Kaleidoscope-ch9.html" title="Chapter 9" class="">Chapter 9</a>
                          </li>
                        </ul>  </li>
                  </ul>        </div>
              </div>
            </div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="kaleidoscope-tutorial">Kaleidoscope Tutorial</h1>

<p>This series of samples generally follows the official <a href="http://releases.llvm.org/5.0.0/docs/tutorial/LangImpl01.html">LLVM tutorial</a>.</p>
<h2 id="overview">Overview</h2>
<p>Kaliedoscope is a simple functional language that is used to illustrate numerous real world
use cases for Llvm.NET for code generation and JIT execution. </p>
<p>It is worth pointing out that this example isn&#39;t intended as a treatise on compiler design nor
on language parsing. While it contains aspects of those topics the sample is focused on the
use of Llvm.NET for code generation. Furthermore it isn&#39;t a trans-literation of the LLVM C++
sample as that would defeat one of the major points of Llvm.NET - to provde a familiar API and
use pattern to C# developers.</p>
<h2 id="general-layout">General layout</h2>
<p>The Llvm.NET version of the Kaleidoscope series takes a different route for parsing from the
LLVM implementation. In particular the Llvm.NET version defines a formal grammar using <a href="http://antlr.org">ANTLR</a>
with the full grammar for all variations of the language features in a single assembly. This
helps in isolating the parsing from the use of Llvm.NET and minimizes the need for any sort
of custom AST. (The antlr parse tree is generally sufficient to generate code)</p>
<h2 id="the-kaleidoscope-language">The Kaleidoscope Language</h2>
<h3 id="general-concepts">General Concepts</h3>
<p>Kaleidoscope is a simple functional language with the following major features:</p>
<ul>
<li>Only a single data type (equivalent to C double)</li>
<li>Built-in operators for basic expressions</li>
<li>If/then/else style control flow</li>
<li>For loop style control flow</li>
<li>User defined operators<ul>
<li>User defined operators can specify operator precedence</li>
</ul>
</li>
</ul>
<h3 id="example">Example</h3>
<p>The following example is a complete program in Kaleidoscope that will generate a textual representation
of the classic Mandelbrot Set.</p>
<pre><code class="lang-Kaleidoscope">def unary!(v)
  if v then
    0
  else
    1;

def unary-(v)
  0-v;

def binary&gt; 10 (LHS RHS)
  RHS &lt; LHS;

def binary| 5 (LHS RHS)
  if LHS then
    1
  else if RHS then
    1
  else
    0;

def binary&amp; 6 (LHS RHS)
  if !LHS then
    0
  else
    !!RHS;

def binary= 9 (LHS RHS)
  !(LHS &lt; RHS | LHS &gt; RHS);

def binary : 1 (x y) y;

extern putchard(char);

def printdensity(d)
  if d &gt; 8 then
    putchard(32)
  else if d &gt; 4 then
    putchard(46)
  else if d &gt; 2 then
    putchard(43)
  else
    putchard(42);

def mandelconverger(real imag iters creal cimag)
  if iters &gt; 255 | (real*real + imag*imag &gt; 4) then
    iters
  else
    mandelconverger( real*real - imag*imag + creal
                   , 2*real*imag + cimag
                   , iters+1
                   , creal
                   , cimag
                   );

def mandelconverge(real imag)
  mandelconverger(real, imag, 0, real, imag);

def mandelhelp(xmin xmax xstep   ymin ymax ystep)
  for y = ymin, y &lt; ymax, ystep in
  (
    (for x = xmin, x &lt; xmax, xstep in printdensity(mandelconverge(x,y))) : putchard(10)
  );

def mandel(realstart imagstart realmag imagmag)
  mandelhelp(realstart, realstart+realmag*78, realmag, imagstart, imagstart+imagmag*40, imagmag);

mandel(-2.3, -1.3, 0.05, 0.07);
</code></pre><p>When entered ( or copy/pasted) to the command line Kaleidoscope will print out the following:</p>
<div class="NOTE"><h5>Note</h5><p>This example uses features of the language only enabled/discussed in Chapter 6 of the tutorial.
The runtime from earlier chapters will generate errors trying to parse this code.</p>
</div>
<pre><code>*******************************************************************************
*******************************************************************************
****************************************++++++*********************************
************************************+++++...++++++*****************************
*********************************++++++++.. ...+++++***************************
*******************************++++++++++..   ..+++++**************************
******************************++++++++++.     ..++++++*************************
****************************+++++++++....      ..++++++************************
**************************++++++++.......      .....++++***********************
*************************++++++++.   .            ... .++**********************
***********************++++++++...                     ++**********************
*********************+++++++++....                    .+++*********************
******************+++..+++++....                      ..+++********************
**************++++++. ..........                        +++********************
***********++++++++..        ..                         .++********************
*********++++++++++...                                 .++++*******************
********++++++++++..                                   .++++*******************
*******++++++.....                                    ..++++*******************
*******+........                                     ...++++*******************
*******+... ....                                     ...++++*******************
*******+++++......                                    ..++++*******************
*******++++++++++...                                   .++++*******************
*********++++++++++...                                  ++++*******************
**********+++++++++..        ..                        ..++********************
*************++++++.. ..........                        +++********************
******************+++...+++.....                      ..+++********************
*********************+++++++++....                    ..++*********************
***********************++++++++...                     +++*********************
*************************+++++++..   .            ... .++**********************
**************************++++++++.......      ......+++***********************
****************************+++++++++....      ..++++++************************
*****************************++++++++++..     ..++++++*************************
*******************************++++++++++..  ...+++++**************************
*********************************++++++++.. ...+++++***************************
***********************************++++++....+++++*****************************
***************************************++++++++********************************
*******************************************************************************
*******************************************************************************
*******************************************************************************
*******************************************************************************
*******************************************************************************
</code></pre><h3 id="formal-grammar">Formal Grammar</h3>
<h4 id="lexer-symbols">Lexer symbols</h4>
<p>The Kaleidoscope lexer consists of several tokens and is defined in the Kaleidoscope.g4 grammar file</p>
<pre><code class="lang-c" name="Lexer">
// Lexer Rules -------
fragment NonZeroDecimalDigit_: [1-9];
fragment DecimalDigit_: [0-9];
fragment Digits_: &#39;0&#39; | [1-9][0-9]*;
fragment EndOfFile_: &#39;\u0000&#39; | &#39;\u001A&#39;;
fragment EndOfLine_
    : (&#39;\r&#39; &#39;\n&#39;)
    | (&#39;\r&#39; |&#39;\n&#39; | &#39;\u2028&#39; | &#39;\u2029&#39;)
    | EndOfFile_
    ;

LPAREN: &#39;(&#39;;
RPAREN: &#39;)&#39;;
COMMA: &#39;,&#39;;
SEMICOLON: &#39;;&#39;;
DEF: &#39;def&#39;;
EXTERN: &#39;extern&#39;;

ASSIGN:&#39;=&#39;;
ASTERISK: &#39;*&#39;;
PLUS: &#39;+&#39;;
MINUS:&#39;-&#39;;
LEFTANGLE: &#39;&lt;&#39;;
SLASH: &#39;/&#39;;

EXCLAMATION: &#39;!&#39;;
PERCENT: &#39;%&#39;;
AMPERSAND:&#39;&amp;&#39;;
PERIOD:&#39;.&#39;;
COLON: &#39;:&#39;;
RIGHTANGLE: &#39;&gt;&#39;;
QMARK: &#39;?&#39;;
ATSIGN: &#39;@&#39;;
BACKSLASH: &#39;\\&#39;;
CARET: &#39;^&#39;;
UNDERSCORE: &#39;_&#39;;
VBAR: &#39;|&#39;;
EQUALEQUAL: &#39;==&#39;;
NOTEQUAL: &#39;!=&#39;;
PLUSPLUS: &#39;++&#39;;
MINUSMINUS: &#39;--&#39;;

IF:     {FeatureControlFlow}? &#39;if&#39;;
THEN:   {FeatureControlFlow}? &#39;then&#39;;
ELSE:   {FeatureControlFlow}? &#39;else&#39;;
FOR:    {FeatureControlFlow}? &#39;for&#39;;
IN:     {FeatureControlFlow}? &#39;in&#39;;
VAR:    {FeatureMutableVars}? &#39;var&#39;;
UNARY:  {FeatureUserOperators}? &#39;unary&#39;;
BINARY: {FeatureUserOperators}? &#39;binary&#39;;

LineComment: &#39;#&#39; ~[\r\n]* EndOfLine_ -&gt; skip;
WhiteSpace: [ \t\r\n\f]+ -&gt; skip;

Identifier: [a-zA-Z][a-zA-Z0-9]*;
Number: Digits_ (&#39;.&#39; DecimalDigit_+)?;
</code></pre><p>This includes basic numeric patterns as well as Identifiers and the symbols allowed for operators and keywords
for the language. Subsequent chapters will introduce the meaning and use of each of these.</p>
<h4 id="parser">Parser</h4>
<p>The parser uses a technique of ANTLR called Semantic Predicates, that allows for dynamic adaptation of the grammar
and parser to handle variations or versions of the language. The Sample code uses that to selectively enable language
features as the chapters progress, without needing to change the grammar or generated parser code. The parser code
provides a simple means of expressing the language support level. Semantic predicates play a vital role in supporting
user defined operators with user defined precedence.</p>
<h5 id="parser-grammar">Parser grammar</h5>
<pre><code class="lang-c" name="Lexer">// Parser rules ------

// built-in operator symbols
builtinop
    : ASSIGN
    | ASTERISK
    | PLUS
    | MINUS
    | SLASH
    | LEFTANGLE
    | CARET
    ;

// Allowed user defined binary symbols
userdefinedop
    : EXCLAMATION
    | PERCENT
    | AMPERSAND
    | PERIOD
    | COLON
    | RIGHTANGLE
    | QMARK
    | ATSIGN
    | BACKSLASH
    | UNDERSCORE
    | VBAR
    | EQUALEQUAL
    | NOTEQUAL
    | PLUSPLUS
    | MINUSMINUS
    ;

// unary ops can re-use built-in binop symbols (Except ASSIGN)
unaryop
    : ASTERISK
    | PLUS
    | MINUS
    | SLASH
    | LEFTANGLE
    | CARET
    | userdefinedop
    ;

// All binary operators
binaryop
    : builtinop
    | userdefinedop
    ;

// pull the initializer out to a distinct rule so it is easier to get at
// the list of initializers when walking the parse tree
initializer
    : Identifier (ASSIGN expression[0])?
    ;

// Non Left recursive expressions (a.k.a. atoms)
primaryExpression
    : LPAREN expression[0] RPAREN                                                 # ParenExpression
    | Identifier LPAREN (expression[0] (COMMA expression[0])*)? RPAREN            # FunctionCallExpression
    | VAR initializer (COMMA initializer)* IN expression[0]                       # VarInExpression
    | IF expression[0] THEN expression[0] ELSE expression[0]                      # ConditionalExpression
    | FOR initializer COMMA expression[0] (COMMA expression[0])? IN expression[0] # ForExpression
    | {IsPrefixOp()}? unaryop expression[0]                                       # UnaryOpExpression
    | Identifier                                                                  # VariableExpression
    | Number                                                                      # ConstExpression;

// Need to make precedence handling explicit in the code behind
// since precedence is potentially user defined at runtime.
expression[int _p]
    : primaryExpression
      ( {GetPrecedence() &gt;= $_p}? binaryop expression[GetNextPrecedence()]
      )*
    ;

prototype
    : Identifier LPAREN (Identifier)* RPAREN                           # FunctionPrototype
    | UNARY unaryop Number? LPAREN Identifier RPAREN                   # UnaryPrototype
    | BINARY userdefinedop Number? LPAREN Identifier Identifier RPAREN # BinaryPrototype
    ;

repl
    : DEF prototype expression[0] # FunctionDefinition
    | EXTERN prototype            # ExternalDeclaration
    | expression[0]               # TopLevelExpression
    | SEMICOLON                   # TopLevelSemicolon
    ;
</code></pre><p>A full tutorial on ANTLR is beyond the scope of this tutorial but the basics should be familiar
enough to anyone acquainted with EBNF form to make enough sense out of it. Don&#39;t worry too much
about the details at this point as subsequent chapters will cover salient points as new features
are enabled.</p>
</article>
          </div>
          <div class="contribution-panel mobile-hide">
              <a href="https://github.com/UbiquityDotNET/Llvm.NET/blob/master/docfx/articles/Samples/Kaleidoscope.md/#L1" title="Improve this Doc" class="fab btn-warning pull-right"><i class="glyphicon glyphicon-pencil"></i></a>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            Copyright (C) 2017, Dot NET Foundation
            
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
  </body>
</html>
